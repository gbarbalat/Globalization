# Just show the results

# Load Libraries and Data
library(dplyr)
library(lmtp)
library(table1)
library(ggplot2)
library(tidyr)

# Clear workspace and load data
rm(list = ls())
sensit <- ""  # Sensitivity setting
data_file <- paste0("results_lmtp_Quality", sensit, ".RData")
loaded_data <- load(file = data_file)

# Define Indices for Data Access
indices <- list(
  psi1 = 1,
  psi2 = 2,
  psi3 = 3,
  psi4 = 4,
  psi_null_KOFGI = 5,
  psi_mtp_KOFGI = 6,
  results_MSM_categ = 7,
  results_mtp_KOFGI = 8,
  matrix = 9
)

# Function to Render Table1
render_table1 <- function(data) {
  table1(
    ~ Y + Y_0 + unemploy + SDI + urban + CSA + p90p100 + haqi + Quality | categ_KOFGI_labels,
    render.continuous = function(x) {
      with(stats.apply.rounding(stats.default(x), digits = 2, round.integers = FALSE),
           c(
             "Mean (SD)" = sprintf("%s (Â± %s)", MEAN, SD),
             "Range" = sprintf("%s-%s", MIN, MAX)
           ))
    },
    data = data
  )
}

# Loop Through Data for Analysis
for (i in seq_along(psi_results_data)) {
  
  if (i == 10) next # Skip index 10
  
  # Extract relevant data
  psi_data <- lapply(indices, function(idx) psi_results_data[[i]][[idx]])
  
  final_matrix <- psi_results_data[[i]][[indices$matrix]]
  
  # Print Cause Information
  cause_title <- unique(final_matrix$cause)
  print(cause_title)
  
  # Identify Outliers
  outliers_max <- final_matrix$log_Y >= quantile(final_matrix$log_Y, 0.99)
  outliers_min <- final_matrix$log_Y <= quantile(final_matrix$log_Y, 0.01)
  
  print(final_matrix$location[outliers_max])
  print(final_matrix[outliers_max, ])
  
  print(final_matrix$location[outliers_min])
  print(final_matrix[outliers_min, ])
  
  # Generate Plots
  plot_boxplot <- function(y_var, x_var, title) {
    ggplot(final_matrix, aes_string(y = y_var, x = x_var, colour = x_var)) +
      geom_boxplot() +
      labs(x = 'Globalization Index (2018)', y = title, title = cause_title) +
      theme_minimal() +
      theme(
        axis.title.x = element_text(face = "bold", size = 16),
        axis.title.y = element_text(face = "bold", size = 16),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        plot.title = element_text(face = "bold", size = 20)
      )
  }
  
  print(plot_boxplot("Y", "categ_KOFGI_labels", "2019 DALYs"))
}
